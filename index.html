<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f1f5f9">
    <title>中鋼磅單辨識系統 v2.6.2</title>
    
    <!-- 核心套件 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <style>
        :root { 
            --safe-top: env(safe-area-inset-top); 
            --safe-bottom: env(safe-area-inset-bottom); 
        }
        
        body { 
            padding-top: var(--safe-top); 
            padding-bottom: var(--safe-bottom); 
            background-color: #f1f5f9; 
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .ios-blur { 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: saturate(180%) blur(20px); 
            -webkit-backdrop-filter: saturate(180%) blur(20px); 
        }

        .modal-blur {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .brand-text {
            background: linear-gradient(135deg, #4f46e5 0%, #2563eb 50%, #3b82f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 900;
            letter-spacing: -0.06em;
            filter: drop-shadow(0 2px 4px rgba(37, 99, 235, 0.1));
        }

        /* 拖曳樣式 */
        .record-card {
            transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1), box-shadow 0.2s ease;
            touch-action: none;
            user-select: none;
            cursor: grab;
        }
        .record-card:active { cursor: grabbing; }
        .record-card.dragging { 
            opacity: 0.4; 
            transform: scale(1.02); 
            background: #eff6ff;
            border-color: #3b82f6;
            z-index: 50;
        }

        .preview-img-container { width: 100%; height: 100px; border-radius: 12px; overflow: hidden; border: 1.5px solid #e2e8f0; background: #1e293b; position: relative; }
        .preview-img { width: 100%; height: 100%; object-fit: contain; transition: transform 0.3s ease; }
        
        .remove-x { position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; items: center; justify-content: center; font-size: 14px; font-weight: bold; border: 2px solid white; cursor: pointer; z-index: 20; }
        .rotate-btn { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; width: 28px; height: 28px; border-radius: 8px; display: flex; items: center; justify-content: center; cursor: pointer; z-index: 10; }

        .dir-option { border: 2.5px solid #e2e8f0; padding: 10px; border-radius: 14px; transition: all 0.2s; text-align: center; cursor: pointer; background: white; }
        .dir-option.active { border-color: #3b82f6; background-color: #eff6ff; color: #1d4ed8; }

        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; transition: all 0.3s; }
        .dot-red { background-color: #ef4444; box-shadow: 0 0 8px #ef4444; }
        .dot-green { background-color: #22c55e; box-shadow: 0 0 10px #22c55e; animation: pulse 2s infinite; }
        .dot-gray { background-color: #cbd5e1; }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.25); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .scroll-hide::-webkit-scrollbar { display: none; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.9) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .modal-animate { animation: modalIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    </style>
</head>
<body class="font-sans antialiased text-slate-900">

    <div class="max-w-md mx-auto min-h-screen relative flex flex-col">
        <!-- 導覽列 -->
        <nav class="ios-blur sticky top-0 z-40 px-5 py-3 border-b border-slate-200 flex justify-between items-center">
            <div>
                <h1 class="text-2xl brand-text italic uppercase leading-none tracking-tighter">CSC Scanner</h1>
                <p class="text-[9px] font-black text-slate-400 uppercase tracking-[0.2em] mt-1">中鋼磅單辨識系統 v2.6.2</p>
            </div>
            <div class="flex items-center gap-3">
                <span id="statDisplay" class="text-[10px] font-black text-slate-500 uppercase">0 幾筆資料</span>
                <div id="apiDot" class="status-dot dot-gray"></div>
                <button onclick="toggleHelp(true)" class="w-9 h-9 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </button>
            </div>
        </nav>

        <main class="p-4 space-y-4 flex-1">
            <!-- 上傳區域 -->
            <div class="bg-white rounded-3xl p-5 shadow-sm border border-slate-100">
                <div id="dropZone" class="bg-slate-50 border-2 border-dashed border-slate-200 rounded-2xl py-10 text-center cursor-pointer flex flex-col items-center hover:bg-slate-100 transition-colors group">
                    <div class="w-14 h-14 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-3 group-active:scale-90 transition-transform">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    </div>
                    <p class="text-sm font-black text-slate-600">點擊拍攝或上傳磅單</p>
                    <p class="text-[10px] text-slate-400 font-bold mt-1 uppercase">Supports Image / PDF</p>
                    <input type="file" id="fileInput" class="hidden" accept="image/*,application/pdf" multiple>
                </div>

                <div id="previewArea" class="mt-4 flex gap-3 overflow-x-auto pb-4 hidden scroll-hide"></div>

                <div class="mt-4 flex gap-2">
                    <button class="dir-option active flex-1" data-dir="ltr">
                        <span class="text-[11px] font-black uppercase">左至右掃描</span>
                    </button>
                    <button class="dir-option flex-1" data-dir="rtl">
                        <span class="text-[11px] font-black uppercase">右至左掃描</span>
                    </button>
                </div>

                <button id="analyzeBtn" class="w-full mt-4 bg-blue-600 text-white font-black py-4 rounded-2xl shadow-lg active:scale-[0.98] transition-all disabled:bg-slate-200 disabled:shadow-none" disabled>
                    開始 AI 辨識 (<span id="queueNum">0</span>)
                </button>
            </div>

            <!-- 結果列表 -->
            <div id="resultsList" class="space-y-3 pb-40">
                <div id="welcome" class="text-center py-16 opacity-30">
                    <svg class="w-16 h-16 mx-auto mb-2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    <p class="text-xs font-bold italic tracking-widest uppercase text-slate-500">等待資料辨識中</p>
                </div>
            </div>
        </main>

        <!-- 底部 -->
        <footer class="fixed bottom-0 left-0 right-0 ios-blur border-t border-slate-100 p-4 pb-6 flex flex-col gap-3 z-40">
            <div class="flex gap-3">
                <button id="resetBtn" class="flex-1 bg-slate-100 text-slate-500 font-bold py-4 rounded-xl text-sm active:bg-slate-200 transition-colors">清除全部</button>
                <button id="exportBtn" class="flex-[2.5] bg-emerald-600 text-white font-black py-4 rounded-xl text-sm hidden shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                    匯出 Excel (分享)
                </button>
            </div>
            <div class="text-center">
                <p class="text-[9px] font-black text-slate-300 tracking-[0.2em] uppercase italic">Authored by HSH.IKITAI</p>
            </div>
        </footer>
    </div>

    <!-- 說明與驗證 Modal -->
    <div id="helpModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-6 modal-blur">
        <div class="bg-white w-full max-w-sm rounded-[32px] overflow-hidden shadow-2xl modal-animate">
            <div class="bg-slate-900 p-6 text-white text-center">
                <h3 class="text-xl font-black italic tracking-tighter uppercase">系統說明與設定</h3>
                <p class="text-[10px] font-bold opacity-60 mt-1 uppercase">v2.6.2 System Documentation</p>
            </div>
            <div class="p-6 space-y-6 max-h-[60vh] overflow-y-auto scroll-hide">
                <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 shadow-inner">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[11px] font-black uppercase text-blue-600 tracking-tight">Gemini API Key 驗證</label>
                        <span id="verifyStatus" class="text-[9px] font-bold text-slate-400">尚未連線</span>
                    </div>
                    <div class="flex gap-2">
                        <input type="password" id="apiKeyInput" placeholder="輸入 API 金鑰..." class="flex-1 bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:border-blue-500 font-mono shadow-sm">
                        <button id="verifyBtn" class="bg-blue-600 text-white px-4 rounded-xl font-black text-xs active:scale-95 transition-transform">驗證</button>
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <h4 class="text-[12px] font-black text-slate-800 border-l-4 border-blue-500 pl-2 mb-2 uppercase italic">操作注意技巧</h4>
                        <ul class="text-[11px] text-slate-500 space-y-2 font-bold leading-relaxed">
                            <li class="flex items-start gap-2"><span class="text-blue-500">●</span><span>拍攝時請保持磅單平整，避免陰影遮蓋關鍵數字。</span></li>
                            <li class="flex items-start gap-2"><span class="text-blue-500">●</span><span>辨識明細可上下拖曳調整順序，重疊時會自動擠壓換位。</span></li>
                            <li class="flex items-start gap-2"><span class="text-blue-500">●</span><span>光線不足時請開啟閃光燈，提升文字對比度。</span></li>
                        </ul>
                    </div>

                    <div>
                        <h4 class="text-[12px] font-black text-slate-800 border-l-4 border-emerald-500 pl-2 mb-2 uppercase italic">主要功能說明</h4>
                        <ul class="text-[11px] text-slate-500 space-y-2 leading-relaxed">
                            <li class="flex items-start gap-2"><span class="text-emerald-500 font-black">1.</span><span><strong class="text-slate-700">掃描方向：</strong>依流水號位置選擇「左至右」或「右至左」模式。</span></li>
                            <li class="flex items-start gap-2"><span class="text-emerald-500 font-black">2.</span><span><strong class="text-slate-700">時間擷取：</strong>自動辨識進磅與出磅時間並匯入 Excel。</span></li>
                            <li class="flex items-start gap-2"><span class="text-emerald-500 font-black">3.</span><span><strong class="text-slate-700">原生分享：</strong>匯出報表後可直接傳送至通訊軟體。</span></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="p-6 bg-slate-50 border-t border-slate-100">
                <button onclick="toggleHelp(false)" class="w-full bg-slate-900 text-white font-black py-4 rounded-2xl active:scale-95 transition-transform shadow-lg">確認了解</button>
            </div>
        </div>
    </div>

    <!-- 載入層 -->
    <div id="loadingOverlay" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-white/95 backdrop-blur-md">
        <div class="text-center">
            <div class="animate-spin rounded-full h-14 w-14 border-4 border-blue-600 border-t-transparent mx-auto mb-5 shadow-sm"></div>
            <p id="loadingMsg" class="font-black text-slate-800 tracking-[0.2em] uppercase italic text-lg">Gemini AI Processing</p>
            <p class="text-[11px] text-slate-400 mt-2 font-black italic tracking-widest"><span id="currentNum">1</span> / <span id="totalNum">1</span> 檔案處理中</p>
        </div>
    </div>

    <script>
        const APP_ID = "csc-scanner-2.6.2";
        const model = "gemini-2.5-flash-lite"; 
        let userApiKey = localStorage.getItem(`${APP_ID}_KEY`) || "";
        let queue = [];
        let history = []; 
        let scanConfig = "ltr";
        let draggedItem = null;

        const ui = {
            input: document.getElementById('fileInput'),
            drop: document.getElementById('dropZone'),
            previews: document.getElementById('previewArea'),
            btn: document.getElementById('analyzeBtn'),
            list: document.getElementById('resultsList'),
            welcome: document.getElementById('welcome'),
            loading: document.getElementById('loadingOverlay'),
            export: document.getElementById('exportBtn'),
            stats: document.getElementById('statDisplay'),
            reset: document.getElementById('resetBtn'),
            help: document.getElementById('helpModal'),
            curr: document.getElementById('currentNum'),
            total: document.getElementById('totalNum'),
            keyInput: document.getElementById('apiKeyInput'),
            verifyBtn: document.getElementById('verifyBtn'),
            verifyStatus: document.getElementById('verifyStatus'),
            apiDot: document.getElementById('apiDot')
        };

        window.onload = () => {
            document.body.style.backgroundColor = "#f1f5f9";
            if(userApiKey) {
                ui.keyInput.value = userApiKey;
                verifyKey(userApiKey);
            }
            ui.drop.onclick = () => ui.input.click();
            ui.input.onchange = handleFileSelect;
            ui.btn.onclick = startAnalysis;
            ui.verifyBtn.onclick = () => verifyKey(ui.keyInput.value.trim());
            ui.reset.onclick = () => { if(confirm("確定清除目前所有辨識資料？")) { history=[]; renderHistory(); } };
            ui.export.onclick = exportToExcel;

            // 初始化拖曳事件監聽
            setupDragging();
        };

        async function verifyKey(key) {
            if(!key) return;
            ui.verifyBtn.disabled = true;
            ui.verifyStatus.innerText = "驗證中...";
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: "ping" }] }] })
                });
                if(res.ok) {
                    userApiKey = key;
                    localStorage.setItem(`${APP_ID}_KEY`, key);
                    ui.verifyStatus.innerText = "✓ 成功連線";
                    ui.verifyStatus.className = "text-[9px] font-bold text-emerald-500";
                    ui.apiDot.className = "status-dot dot-green";
                } else { throw new Error(); }
            } catch(e) {
                ui.verifyStatus.innerText = "✕ 金鑰錯誤";
                ui.verifyStatus.className = "text-[9px] font-bold text-red-500";
                ui.apiDot.className = "status-dot dot-red";
                userApiKey = "";
            } finally { ui.verifyBtn.disabled = false; }
        }

        window.toggleHelp = (show) => ui.help.classList.toggle('hidden', !show);

        async function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            for (const f of files) {
                const id = Math.random().toString(36).substring(7);
                let src = (f.type === 'application/pdf') ? await pdfToImg(f) : await imgToCanvas(f);
                queue.push({ id, file: f, src, rotation: 0 });
                renderQueue();
            }
            ui.input.value = "";
        }

        async function imgToCanvas(file) {
            return new Promise(r => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        const MAX = 1600; 
                        if (w > h && w > MAX) { h *= MAX/w; w = MAX; }
                        else if (h > w && h > MAX) { w *= MAX/h; h = MAX; }
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        r(canvas.toDataURL('image/jpeg', 0.85));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function pdfToImg(file) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            const ab = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: ab }).promise;
            const page = await pdf.getPage(1);
            const vp = page.getViewport({ scale: 2.0 });
            const canvas = document.createElement('canvas');
            canvas.height = vp.height; canvas.width = vp.width;
            await page.render({ canvasContext: canvas.getContext('2d'), viewport: vp }).promise;
            return canvas.toDataURL('image/jpeg', 0.85);
        }

        window.rotateItem = (id) => {
            const item = queue.find(q => q.id === id);
            if (item) {
                item.rotation = (item.rotation + 90) % 360;
                document.querySelector(`[data-id="${id}"] .preview-img`).style.transform = `rotate(${item.rotation}deg)`;
            }
        };

        window.removeItem = (id) => { queue = queue.filter(f => f.id !== id); renderQueue(); };

        function renderQueue() {
            ui.previews.classList.toggle('hidden', queue.length === 0);
            ui.btn.disabled = queue.length === 0;
            document.getElementById('queueNum').innerText = queue.length;
            ui.previews.innerHTML = queue.map((f, i) => `
                <div class="relative flex-shrink-0 w-24" data-id="${f.id}">
                    <div class="remove-x" onclick="removeItem('${f.id}')">×</div>
                    <div class="preview-img-container">
                        <img src="${f.src}" class="preview-img" style="transform: rotate(${f.rotation}deg)">
                    </div>
                    <div class="rotate-btn" onclick="rotateItem('${f.id}')">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                    </div>
                </div>
            `).join('');
        }

        async function startAnalysis() {
            if(!userApiKey) { alert("請先進行 API 金鑰驗證"); toggleHelp(true); return; }
            ui.loading.classList.remove('hidden');
            const batch = [...queue];
            ui.total.innerText = batch.length;
            queue = []; renderQueue();
            for (let i = 0; i < batch.length; i++) {
                ui.curr.innerText = i + 1;
                const rotatedBase64 = await finalizeImage(batch[i]);
                const result = await callGemini(rotatedBase64);
                if (result) {
                    const dataArray = Array.isArray(result) ? result : [result];
                    dataArray.forEach(d => {
                        d._id = Math.random().toString(36).substring(7);
                        history.push(d);
                    });
                    renderHistory();
                }
            }
            ui.loading.classList.add('hidden');
        }

        async function finalizeImage(item) {
            return new Promise(r => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    if (item.rotation % 180 !== 0) {
                        canvas.width = img.height; canvas.height = img.width;
                    } else {
                        canvas.width = img.width; canvas.height = img.height;
                    }
                    ctx.translate(canvas.width/2, canvas.height/2);
                    ctx.rotate(item.rotation * Math.PI / 180);
                    ctx.drawImage(img, -img.width/2, -img.height/2);
                    r(canvas.toDataURL('image/jpeg', 0.9).split(',')[1]);
                };
                img.src = item.src;
            });
        }

        async function callGemini(base64) {
            const dir = scanConfig === "ltr" ? "左至右" : "右至左";
            const prompt = `你現在是中鋼磅單辨識專家。辨識這張圖片並精確提取 JSON：date (日期), time_in (進磅時間), time_out (出磅時間), material (品名), truck_id (車號), gross_weight (總重), empty_weight (空重), net_weight (淨重), serial (磅單編號)。辨識掃描方向為：${dir}。只需回傳 JSON 字串，不要任何輔助文字。`;
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${userApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64 } }] }],
                        generationConfig: { responseMimeType: "application/json", temperature: 0.1 }
                    })
                });
                const d = await res.json();
                return JSON.parse(d.candidates[0].content.parts[0].text);
            } catch (e) { return null; }
        }

        function renderHistory() {
            ui.stats.innerText = `${history.length} 幾筆資料`;
            ui.export.classList.toggle('hidden', history.length === 0);
            ui.welcome.classList.toggle('hidden', history.length > 0);
            ui.list.innerHTML = history.map((h, i) => `
                <div class="record-card bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-1" 
                     draggable="true" data-id="${h._id}">
                    <div class="px-3 text-slate-300 pointer-events-none">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 8h16M4 16h16"/></svg>
                    </div>
                    <div class="flex-1 pointer-events-none">
                        <div class="flex justify-between mb-1">
                            <span class="text-[9px] font-black bg-blue-600 text-white px-2 py-0.5 rounded italic shadow-sm">#${i+1}</span>
                            <span class="text-[10px] font-bold text-slate-400 font-mono tracking-tighter">${h.date || '---'}</span>
                        </div>
                        <div class="flex justify-between items-end">
                            <div>
                                <p class="text-lg font-black text-slate-800 tracking-tight leading-none">${h.truck_id || '---'}</p>
                                <p class="text-[10px] text-slate-400 font-bold uppercase mt-1 italic truncate max-w-[120px]">${h.material || '品名'}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-black text-blue-600 italic font-mono leading-none">${h.net_weight || 0}</p>
                                <p class="text-[8px] font-bold text-slate-400 uppercase italic leading-none mt-1">Net KG</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="deleteRow('${h._id}')" class="p-2 text-slate-200 hover:text-red-500 transition-colors pointer-events-auto">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    </button>
                </div>
            `).join('');
        }

        // 拖曳排序邏輯 (擠壓取代)
        function setupDragging() {
            ui.list.addEventListener('dragstart', (e) => {
                draggedItem = e.target.closest('.record-card');
                draggedItem.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            ui.list.addEventListener('dragend', () => {
                if (draggedItem) {
                    draggedItem.classList.remove('dragging');
                    draggedItem = null;
                }
                const currentCards = Array.from(ui.list.querySelectorAll('.record-card'));
                const newHistory = currentCards.map(card => history.find(h => h._id === card.dataset.id));
                history = newHistory;
                renderHistory();
            });

            ui.list.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(ui.list, e.clientY);
                if (afterElement == null) {
                    ui.list.appendChild(draggedItem);
                } else {
                    ui.list.insertBefore(draggedItem, afterElement);
                }
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.record-card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        window.deleteRow = (id) => { history = history.filter(h => h._id !== id); renderHistory(); };

        async function exportToExcel() {
            if (history.length === 0) return;
            // 欄位順序：序號, 日期, 品名, 車號 (品名後增加車號), 進磅時間, 出磅時間, 空重, 總重, 淨重, 磅單編號
            const data = history.map((h, i) => ({ 
                "序號": i + 1, 
                "日期": h.date, 
                "品名": h.material, 
                "車號": h.truck_id, // 調整至此：車號放在品名後面
                "進磅時間": h.time_in || '---',
                "出磅時間": h.time_out || '---',
                "空重": h.empty_weight, 
                "總重": h.gross_weight, 
                "淨重": h.net_weight, 
                "磅單編號": h.serial 
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "磅單數據");
            
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const fileName = `CSC_Report_${new Date().getTime()}.xlsx`;
            const file = new File([wbout], fileName, { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });

            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: '中鋼磅單報表',
                        text: '這是由聯鋼開發 HSU SHIH HUNG 製作的報表。'
                    });
                } catch (err) {
                    fallbackDownload(file, fileName);
                }
            } else {
                fallbackDownload(file, fileName);
            }
        }

        function fallbackDownload(file, fileName) {
            const url = URL.createObjectURL(file);
            const a = document.createElement("a");
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
        }

        document.querySelectorAll('.dir-option').forEach(opt => {
            opt.onclick = () => {
                document.querySelectorAll('.dir-option').forEach(el => el.classList.remove('active'));
                opt.classList.add('active');
                scanConfig = opt.dataset.dir;
            };
        });
    </script>
</body>
</html>

